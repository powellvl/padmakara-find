<!-- Section Fichiers du texte (style Google Drive simplifié) -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8 transition-colors duration-200" 
     data-controller="text-files"
     data-text-id="<%= @text.id %>"
     data-action="drop->text-files#handleDrop dragover->text-files#handleDragOver dragleave->text-files#handleDragLeave">
  
  <!-- En-tête simplifié -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
    <div class="flex items-center gap-3">
      <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
      </svg>
      <h2 class="text-base font-medium text-gray-700">Fichiers</h2>
      <% if @text.files.any? %>
        <span class="text-sm text-gray-500">(<%= @text.files.count %>)</span>
      <% end %>
    </div>
    
    <!-- Bouton d'ajout simple -->
    <% if Current.user&.admin? %>
      <button type="button" 
              class="inline-flex items-center gap-2 px-3 py-1.5 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors duration-200"
              data-action="click->text-files#openFileSelector">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Ajouter
      </button>
      <!-- Input file caché -->
      <input type="file" multiple class="hidden" data-text-files-target="fileInput" data-action="change->text-files#handleFileSelect">
    <% end %>
  </div>

  <!-- Liste des fichiers (style Google Drive) -->
  <div data-text-files-target="filesList">
    <% @text.files.each do |file| %>
      <div class="flex items-center px-6 py-3 hover:bg-gray-50 transition-colors duration-150 group border-b border-gray-50 last:border-b-0 cursor-move"
          data-text-files-target="fileItem"
          data-file-id="<%= file.id %>"
          draggable="true"
          data-action="dragstart->text-files#handleFileDragStart dragend->text-files#handleFileDragEnd dragover->text-files#handleFileDragOver drop->text-files#handleFileDrop"
          title="Glisser pour réorganiser">
        
        <!-- Icône minimaliste -->
        <div class="flex-shrink-0 mr-3">
          <% file_extension = File.extname(file.filename.to_s).downcase %>
          <% case file_extension %>
          <% when '.pdf' %>
            <div class="w-6 h-6 flex items-center justify-center">
              <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
              </svg>
            </div>
          <% when '.doc', '.docx' %>
            <div class="w-6 h-6 flex items-center justify-center">
              <svg class="h-5 w-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
              </svg>
            </div>
          <% when '.jpg', '.jpeg', '.png', '.gif' %>
            <div class="w-6 h-6 flex items-center justify-center">
              <svg class="h-5 w-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          <% else %>
            <div class="w-6 h-6 flex items-center justify-center">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
          <% end %>
        </div>

        <!-- Nom du fichier et tags -->
        <div class="flex-1 min-w-0 mr-4" data-controller="file-tags">
          <p class="text-sm text-gray-900 truncate font-medium mb-1">
            <%= file.filename %>
          </p>
          
          <!-- Tags du fichier utilisant le composant réutilisable -->
          <%= render "shared/file_tags", file: file %>
        </div>

        <!-- Métadonnées compactes -->
        <div class="hidden sm:flex items-center gap-4 text-xs text-gray-500 mr-4">
          <span><%= number_to_human_size(file.byte_size) %></span>
          <span><%= time_ago_in_words(file.created_at) %></span>
        </div>

        <!-- Actions au hover -->
        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
          <!-- Télécharger -->
          <%= link_to rails_blob_path(file, disposition: "attachment"), 
                      class: "p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors duration-200",
                      title: "Télécharger" do %>
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
          <% end %>

          <!-- Supprimer (admin seulement) -->
          <% if Current.user&.admin? %>
            <button type="button" 
                    class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors duration-200"
                    data-action="click->text-files#deleteFile"
                    data-file-id="<%= file.id %>"
                    title="Supprimer">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Message si aucun fichier -->
    <% if @text.files.empty? %>
      <div class="px-6 py-8 text-center">
        <svg class="mx-auto h-8 w-8 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
        </svg>
        <p class="text-sm text-gray-500">Aucun fichier</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Modal de sélection des tags -->
<div id="tagSelectorModal" 
     class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden"
     data-text-files-target="tagModal"
     data-action="click->text-files#closeTagModal">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
       data-action="click->text-files#stopPropagation">
    
    <!-- En-tête de la modal -->
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-medium text-gray-900">Ajouter un tag</h3>
      <button type="button" 
              class="text-gray-400 hover:text-gray-600"
              data-action="click->text-files#closeTagModal">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Liste des tags disponibles -->
    <div class="max-h-64 overflow-y-auto">
      <div class="space-y-2" data-text-files-target="availableTags">
        <% if defined?(@available_tags) %>
          <% @available_tags.each do |tag| %>
            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
              <input type="checkbox" 
                     class="mr-3 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                     data-tag-id="<%= tag.id %>"
                     data-tag-name="<%= tag.name %>">
              <span class="text-sm text-gray-900">#<%= tag.name %></span>
            </label>
          <% end %>
        <% else %>
          <!-- Fallback si les tags ne sont pas disponibles -->
          <p class="text-sm text-gray-500 text-center py-4">Chargement des tags...</p>
        <% end %>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="flex justify-end space-x-2 mt-4 pt-4 border-t">
      <button type="button" 
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
              data-action="click->text-files#closeTagModal">
        Annuler
      </button>
      <button type="button" 
              class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
              data-action="click->text-files#applyTags">
        Ajouter
      </button>
    </div>
  </div>
</div>
