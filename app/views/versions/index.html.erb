<% if notice %>
  <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
    <%= notice %>
  </div>
<% end %>

<% content_for :title, "Versions" %>
<% content_for :head do %>
  <%= stylesheet_link_tag 'text_files', 'data-turbo-track': 'reload' %>
<% end %>
<div class="container mx-auto px-6 py-8">
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Versions de <span class="text-indigo-600"><%= @text.title_tibetan %></span></h1>
      <p class="text-gray-600"><%= @versions.count %> version<%= 's' if @versions.count > 1 %> disponible<%= 's' if @versions.count > 1 %></p>
    </div>
    <% if Current.user&.admin? %>
      <%= link_to "Nouvelle version", new_text_translation_version_path(@text, @translation), 
          class: "bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center gap-2" %>
    <% end %>
  </div>

  <!-- Section des fichiers de la traduction (style Google Drive) -->
  <%= render "translation_files" %>

  <!-- Grille des versions avec style translation-card -->
  <div class="version-card-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <% @versions.each do |version| %>
      <div class="version-card bg-white/70 backdrop-blur-sm rounded-xl border border-white/20 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02] group relative overflow-hidden">
        
        <!-- Effet de brillance au hover -->
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
          <div class="absolute top-0 -inset-full h-full w-1/2 z-5 block transform -skew-x-12 bg-gradient-to-r from-transparent to-white opacity-20 animate-shine"></div>
        </div>

        <div class="relative p-6 z-10">
          <!-- En-tête de la version -->
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="text-lg font-semibold text-gray-900 group-hover:text-indigo-600 transition-colors duration-200">
                  <%= link_to text_translation_version_path(@text, @translation, version), class: "block" do %>
                    Version <%= version.name %>
                  <% end %>
                </h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100/80 text-blue-800 backdrop-blur-sm">
                  <%= version.created_at.strftime("%d %b") %>
                </span>
              </div>
              
              <p class="text-sm text-gray-500 mb-3">
                <%= time_ago_in_words(version.created_at) %>
              </p>
            </div>

            <!-- Menu d'actions -->
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              <%= link_to text_translation_version_path(@text, @translation, version), 
                  class: "p-2 text-gray-400 hover:text-gray-600 hover:bg-white/50 rounded-lg transition-all duration-200",
                  title: "Voir la version" do %>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
              <% end %>
              
              <% if Current.user&.admin? %>
                <%= link_to edit_text_translation_version_path(@text, @translation, version), 
                    class: "p-2 text-gray-400 hover:text-indigo-600 hover:bg-white/50 rounded-lg transition-all duration-200",
                    title: "Modifier la version" do %>
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                <% end %>
              <% end %>
            </div>
          </div>
          
          <!-- Description -->
          <% if version.subtitle.present? %>
            <p class="text-gray-700 text-sm mb-4 leading-relaxed">
              <%= truncate(version.subtitle, length: 120) %>
            </p>
          <% end %>

          <!-- Badges de métadonnées -->
          <div class="flex flex-wrap gap-2 mb-4">
            <% if version.files.attached? %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100/80 text-blue-800 backdrop-blur-sm">
                <%= version.files.count %> fichier<%= 's' if version.files.count > 1 %>
              </span>
            <% end %>
            
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100/80 text-purple-800 backdrop-blur-sm">
              <%= version.status.humanize %>
            </span>
          </div>
          
          <!-- Traduction de cette version -->
          <div class="border-t border-gray-100/50 pt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
              </svg>
              Traduction
            </h4>
            <div class="flex flex-wrap gap-1.5">
              <%= link_to text_translation_path(@text, version.translation), 
                  class: "inline-flex items-center px-2.5 py-1 rounded-lg text-xs bg-gradient-to-r from-gray-50 to-gray-100/80 text-gray-700 hover:from-indigo-50 hover:to-indigo-100/80 hover:text-indigo-700 transition-all duration-200 border border-gray-200/50 hover:border-indigo-200/50 backdrop-blur-sm" do %>
                <%= version.translation.language.name %>
              <% end %>
            </div>
          </div>

          <!-- Section fichiers -->
          <div class="border-t border-gray-100/50 pt-4 mt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
              </svg>
              Fichiers de la version
              <% if version.files.attached? %>
                <span class="text-xs text-gray-500">(<%= version.files.count %>)</span>
              <% end %>
            </h4>
            
            <% if version.files.attached? %>
              <div class="grid grid-cols-2 gap-2">
                <% version.files.limit(4).each do |file| %>
                  <div class="flex items-center gap-2 p-2 rounded-lg bg-gray-50/80 hover:bg-gray-100/80 transition-colors duration-200 group/file">
                    <!-- Icône du fichier -->
                    <% file_extension = File.extname(file.filename.to_s).downcase %>
                    <% case file_extension %>
                    <% when '.pdf' %>
                      <svg class="h-3.5 w-3.5 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                      </svg>
                    <% when '.doc', '.docx' %>
                      <svg class="h-3.5 w-3.5 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                      </svg>
                    <% else %>
                      <svg class="h-3.5 w-3.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                    <% end %>
                    
                    <span class="text-xs text-gray-600 truncate flex-1">
                      <%= truncate(file.filename.to_s, length: 15) %>
                    </span>
                    
                    <!-- Bouton de téléchargement au hover -->
                    <%= link_to rails_blob_path(file, disposition: "attachment"), 
                        class: "opacity-0 group-hover/file:opacity-100 p-1 text-gray-400 hover:text-gray-600 transition-all duration-200",
                        title: "Télécharger" do %>
                      <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                      </svg>
                    <% end %>
                  </div>
                <% end %>
                
                <% if version.files.count > 4 %>
                  <div class="col-span-2 text-center py-2">
                    <%= link_to text_translation_version_path(@text, @translation, version), 
                        class: "text-xs text-indigo-600 hover:text-indigo-700 font-medium" do %>
                      Voir <%= version.files.count - 4 %> fichier<%= 's' if version.files.count - 4 > 1 %> de plus...
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="text-xs text-gray-500 italic">Aucun fichier attaché à cette version</p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
